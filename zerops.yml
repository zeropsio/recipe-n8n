zerops:
  - setup: main
    extends: base
    # deploy:
    #   readinessCheck:
    #     httpGet:
    #       port: 5678
    #       path: /healthz/readiness
    #     failureTimeout: 600s
    #     retryPeriod: 20s
    run:
      ports:
        - httpSupport: true
          port: 5678
      start: n8n
      # healthCheck:
      #   httpGet:
      #     port: 5678
      #     path: /healthz

  - setup: workers
    extends: base
    # deploy:
    #   readinessCheck:
    #     httpGet:
    #       port: 5680
    #       path: /healthz/readiness
    #       host: localhost
    #     failureTimeout: 600s
    #     retryPeriod: 20s
    run:
      start: n8n worker
      # healthCheck:
      #   httpGet:
      #     port: 5680
      #     path: /healthz
      #     host: localhost

  - setup: base
    run:
      base: nodejs@22
      prepareCommands:
        - zsc scale ram max 10m
        - export NODE_OPTIONS=--max-old-space-size=8192; npm install -g n8n@1.120.4
      envVariables:
        NODE_OPTIONS: --max-old-space-size=8192
        NO_COLOR: true

        # VUE_APP_URL_BASE_API: "${zeropsSubdomain}"
        N8N_EDITOR_BASE_URL: ${zeropsSubdomain}

        DB_TYPE: postgresdb
        DB_POSTGRESDB_HOST: ${db_hostname}
        DB_POSTGRESDB_DATABASE: ${db_dbName}
        DB_POSTGRESDB_USER: ${db_user}
        DB_POSTGRESDB_PASSWORD: ${db_password}
        DB_POSTGRESDB_POOL_SIZE: 5

        N8N_ENCRYPTION_KEY: ${ENCRYPTION_KEY}
        N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
        
        N8N_RUNNERS_ENABLED: true
        N8N_RUNNERS_MODE: internal
        
        OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS: true

        N8N_PORT: 5678
        N8N_LISTEN_ADDRESS: "::"
        
        # N8N_PERSONALIZATION_ENABLED: false
        # N8N_VERSION_NOTIFICATIONS_INFO_URL: false
        # N8N_HIRING_BANNER_ENABLED: false
        # N8N_DIAGNOSTICS_ENABLED: false
        # N8N_VERSION_NOTIFICATIONS_ENABLED: false
        # N8N_TEMPLATES_ENABLED: false
        
        # N8N_REINSTALL_MISSING_PACKAGES: true

        # N8N_METRICS: true

        # QUEUE_HEALTH_CHECK_ACTIVE: true
        # QUEUE_HEALTH_CHECK_PORT: 5680

        EXECUTIONS_MODE: queue
        QUEUE_BULL_REDIS_HOST: valkey
        QUEUE_BULL_REDIS_PORT: 6379
        QUEUE_BULL_REDIS_DB: 0

        N8N_EMAIL_MODE: smtp
        N8N_SMTP_PORT: 1025
        N8N_SMTP_HOST: mailpit
        N8N_SMTP_SENDER: hello.from@zerops.io

